<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="_lib.html">

<dom-module id="app-shell">
    <template>
        <!-- build:css(.tmp/elements) ../styles/app.css -->
        <link rel="stylesheet" href="../styles/app.css">
        <!-- endbuild -->

        <div class="bubble_cloud" id="bubble_cloud1"></div>

        <div class$="content-wrapper party-[[ activeParty ]]">
            <div class="tab-wrapper">
                <div class="tab-bar">
                    <iron-selector attr-for-selected="data-select"
                                   selected="{{ activeParty }}"
                                   fallback-selection="all"
                                   class="clearfix">
                        <div class="tab party-all" data-select="all">Alle</div>
                        <template is="dom-repeat" items="[[ parties ]]">
                            <div class$="tab party-[[ item ]]" data-select="[[ item ]]">[[ getPartyName(item) ]]</div>
                        </template>
                    </iron-selector>
                </div>
                <span class="topline"></span>
            </div>
        </div>
    </template>
</dom-module>

<script>
    const partyMap = {
        cdu: "CDU",
        spd: "SPD",
        gruene: "GrÃ¼ne",
        fdp: "FDP",
        linke: "Linke",
        piraten: "Piraten",
        afd: "AFD"
    };

    class AppShell extends Polymer.Element {
        static get is() {
            return 'app-shell';
        }

        static get properties() {
            return {
                parties: {
                    type: Array,
                    value: () => ['cdu', 'spd', 'linke', 'gruene', 'fdp', 'piraten', 'afd']
                },
                activeParty: {
                    type: String,
                    observer: 'selectParty'
                },
                activeWord: {
                    type: String,
                    value: () => ""
                },
                partyMap: {
                    type: Object,
                    value: () => partyMap
                }
            };
        }

        ready() {
            super.ready();

            this.data = [];
        }

        connectedCallback() {
            super.connectedCallback();

            const elem = this.shadowRoot.querySelector('#bubble_cloud1');

            fetch('output/all.json')
                .then(res => res.json())
                .then(json => {
                    this.data = json.data;
                    const bubbles = this.data.slice(0, 30);

                    this.cloud = BubbleCloud(partyMap)(elem, this.prepareData(bubbles));
                });
        }

        prepareData(data) {
            return data.map((item, key) => { return {
                id: item.id || key+1,
                word: item.word,
                count: item.count,
                share: item.share,
                party_counts: _.mapValues(item.segments || {}, d => d.share)
            }; });
        }

        selectParty(id) {
            if(!id || !this.cloud) {
                return;
            }

            const data = (id === 'all') ?
                this.data :
                this.data.map((word, key) => {
                    return {
                        id: key+1,
                        word: word.word,
                        count: (id in word.segments) ? word.segments[id].count : 0,
                        share: (id in word.segments) ? word.segments[id].share : 0
                    };
                }).sort((a,b) => b.count-a.count);

            this.cloud.updateData(this.prepareData(data.slice(0,30)));
        }

        getPartyName(slug) {
            return partyMap[slug];
        }
    }

    customElements.define(AppShell.is, AppShell);
</script>